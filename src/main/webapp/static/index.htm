<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Insert title here</title>

<script src="libraries/adapter.js"></script>
</head>
<body>
	local:
	<video id="localVideo" autoplay></video>
	<br> remote:
	<video id="remoteVideo" autoplay></video>
	<button onclick="start(true);">Start</button>
	<br>
	<div id="channelName"></div>

	<script>
		function Message(signal, conversationId, content) {
			this.signal = signal;
			this.conversationId = conversationId;
			this.content = content;
		}

		navigator.getUserMedia = getUserMedia;
		var endpointURL = 'ws://' + window.location.host + '/nextRTC/signaling';
		var configuration = {
			'iceServers' : [ {
				'url' : 'stun:stun.l.google.com:19302'
			} ]
		};
		var signalingChannel = new WebSocket(endpointURL);
		var pc;
		var roomCreated = false;
		// on ready
		var localView = document.getElementById('localVideo');
		var remoteView = document.getElementById('remoteVideo');

		function start(isCaller) {
			pc = new RTCPeerConnection(configuration);

			pc.onaddstream = function(evt) {
				remoteView.src = URL.createObjectURL(evt.stream);
			};

			navigator.getUserMedia({
				video : true
			}, function(stream) {
				localView.src = URL.createObjectURL(stream);
				pc.addStream(stream);

				if (isCaller) {
					pc.createOffer(gotDescription, error);
				} else {
					pc.createAnswer(gotDescription, error);
				}

				function gotDescription(desc) {
					if (!roomCreated && isCaller) {
						console.log(JSON.stringify(
								new Message('newConversation', null, desc.sdp)
						));
						signalingChannel.send(JSON.stringify(
								new Message('newConversation', null, desc.sdp)
								));
						roomCreated = true;
					}
					pc.setLocalDescription(desc);
					//signalingChannel.send(JSON.stringify({
					//	'sdp' : desc
					//}));
				}
			}, error);
		}

		signalingChannel.onmessage = function(evt) {
			if (!pc)
				start(false);

			var signal = JSON.parse(evt.data);
			if (signal.signal == 'conversationCreated') {
				document.getElementById('channelName').appendChild(
						signal.conversationId);
			}
			if (signal.signal == 'mediaOffer'){
				
			}
			if (signal.signal == 'mediaAnswer'){
				
			}
				//if (signal.sdp) {
				//	pc.setRemoteDescription(new RTCSessionDescription(
				//			signal.sdp));
				//}
		};

		var error = function(error) {
			console.log('error ' + error);
		}
	</script>
</body>
</html>