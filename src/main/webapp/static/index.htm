<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Insert title here</title>

<script src="libraries/adapter.js"></script>
</head>
<body>
	local:
	<video id="localVideo" autoplay></video>
	<br> remote:
	<video id="remoteVideo" autoplay></video>
	<button onclick="start(true);">Start</button>

	<script>
		navigator.getUserMedia = getUserMedia;
		var endpointURL = 'ws://' + window.location.host + '/nextRTC/signaling';
		var configuration = {
			'iceServers' : [ {
				'url' : 'stun:stun.l.google.com:19302'
			} ]
		};
		var signalingChannel = new WebSocket(endpointURL);
		var pc;
		// on ready
		var localView = document.getElementById('localVideo');
		var remoteView = document.getElementById('remoteVideo');

		function start(isCaller) {
			pc = new RTCPeerConnection(configuration);

			pc.onaddstream = function(evt) {
				remoteView.src = URL.createObjectURL(evt.stream);
			};

			navigator.getUserMedia({
				video : true
			}, function(stream) {
				localView.src = URL.createObjectURL(stream);
				pc.addStream(stream);

				if (isCaller) {
					pc.createOffer(gotDescription, error);
				} else {
					pc.createAnswer(gotDescription, error);
				}

				function gotDescription(desc) {
					pc.setLocalDescription(desc);
					signalingChannel.send(JSON.stringify({
						'sdp' : desc
					}));
				}
			}, error);
		}

		signalingChannel.onmessage = function(evt) {
			if (!pc)
				start(false);

			var signal = JSON.parse(evt.data);
			if (signal.sdp) {
				pc.setRemoteDescription(new RTCSessionDescription(signal.sdp));
			}
		};

		var error = function(error) {
			console.log('error ' + error);
		}
	</script>
</body>
</html>